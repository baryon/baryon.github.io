(window.webpackJsonp=window.webpackJsonp||[]).push([[30],{566:function(e,a,t){"use strict";t.r(a);var s=t(8),r=Object(s.a)({},(function(){var e=this,a=e.$createElement,t=e._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("p",[e._v("在前一篇可以想到3种分割完整脚本的办法。")]),e._v(" "),t("h2",{attrs:{id:"push-only"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#push-only"}},[e._v("#")]),e._v(" PUSH ONLY")]),e._v(" "),t("p",[e._v("但现实因为要考虑安全因素，比特币不允许在解锁脚本中放入"),t("code",[e._v("OP_ADD")]),e._v("这样的操作符")]),e._v(" "),t("p",[e._v("也就是下面的形式不允许。")]),e._v(" "),t("p",[e._v("第一段解锁脚本（不允许）")]),e._v(" "),t("div",{staticClass:"language-plain extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("OP_2\nOP_3\nOP_ADD\n")])])]),t("p",[e._v("第二段锁定脚本")]),e._v(" "),t("div",{staticClass:"language-plain extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("OP_5\nOP_EQUAL\n")])])]),t("p",[e._v("OP_2和OP_3将2和3推入栈中，而"),t("code",[e._v("OP_ADD")]),e._v("对栈进行操作。在比特币节点里有设置"),t("code",[e._v("SCRIPT_VERIFY_SIGPUSHONLY")]),e._v("，只允许数据入栈的操作。")]),e._v(" "),t("div",{staticClass:"language-c++ extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("// File: validation.cpp Line:3464\nflags |= SCRIPT_VERIFY_SIGPUSHONLY;\n")])])]),t("p",[e._v("否则会出现下面的错误")]),e._v(" "),t("div",{staticClass:"language-plain extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("16: mandatory-script-verify-flag-failed (Only non-push operators allowed in signatures)\n")])])]),t("p",[e._v("如果允许解锁脚本带有操作符，那么下面的解锁代码可以解锁任意脚本")]),e._v(" "),t("div",{staticClass:"language-plain extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("OP_TRUE\nOP_RETURN\n")])])]),t("p",[t("code",[e._v("PUSHONLY")]),e._v("属于一刀切的禁止方式，应该有更好的实现方式。")]),e._v(" "),t("h2",{attrs:{id:"redeem-script"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#redeem-script"}},[e._v("#")]),e._v(" Redeem Script")]),e._v(" "),t("p",[e._v("那么是否有绕开的方式呢？曾经有一种机制叫做兑换脚本(RedeemScript)， 用于将脚本完全放在解锁脚本中，这个机制的名字叫做支付到脚本(P2SH)")]),e._v(" "),t("p",[e._v("例子如下")]),e._v(" "),t("div",{staticClass:"language-plain extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("const redeem = 'OP_ADD OP_5 OP_EQUAL'\nconst redeemScript = Script.fromASM(redeem)\nconst redeemScriptHex = redeemScript.toHex()\nconst redeemScriptBuffer = redeemScript.toBuffer()\nconst redeemScriptHash = Hash.sha256ripemd160(redeemScriptBuffer)\nconst unlock = `OP_2 OP_3 ${redeemScriptHex}`\nconst lockingScript = `OP_HASH160 ${redeemScriptHash.toString('hex')} OP_EQUAL`\n")])])]),t("p",[e._v("制作一段兑换脚本，比如"),t("code",[e._v("OP_ADD OP_5 OP_EQUAL")]),e._v("，对这段脚本的Hex进行Hash160计算"),t("code",[e._v("(sha256(ripedmd160())")]),e._v(", 将得到的hash填入锁定脚本。将hex放入解锁脚本。")]),e._v(" "),t("p",[e._v("比特币节点运行的时候，会先连接解锁脚本和锁定脚本，计算Hex的Hash160，看看Hex是否等于事先的约定代码。如果是，则解释Hex部分组合成兑换脚本，执行")]),e._v(" "),t("div",{staticClass:"language-plain extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("OP_2 OP_3 OP_ADD OP_5 OP_EQUAL\n")])])]),t("p",[e._v("这种兑换脚本(RedeemScript)的方案属于黑盒，无法从公开在区块链上的锁定脚本看出程序的语义。")]),e._v(" "),t("p",[e._v("此方案已经在2020年2月被比特币禁止。")]),e._v(" "),t("p",[e._v("如果还想广播这样的脚本，比特币节点会返回")]),e._v(" "),t("div",{staticClass:"language-plain extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("16: bad-txns-vout-p2sh\n")])])]),t("h2",{attrs:{id:"困局"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#困局"}},[e._v("#")]),e._v(" 困局")]),e._v(" "),t("p",[e._v("车到山前，路呢？")]),e._v(" "),t("p",[e._v("柳暗花明，村呢？")]),e._v(" "),t("blockquote",[t("p",[e._v("享受比特币带来的安全自由， 关注使用"),t("a",{attrs:{href:"https://note.sv",target:"_blank",rel:"noopener noreferrer"}},[e._v("NoteSV"),t("OutboundLink")],1)])])])}),[],!1,null,null,null);a.default=r.exports}}]);