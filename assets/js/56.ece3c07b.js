(window.webpackJsonp=window.webpackJsonp||[]).push([[56],{594:function(t,s,a){"use strict";a.r(s);var n=a(8),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("p",[t._v("sCrypt是比特币合约走出来的第一步。我们看看sCrypt创造的新技术："),a("code",[t._v("OP_PUSH_TX")])]),t._v(" "),a("p",[a("code",[t._v("OP_PUSH_TX")]),t._v("以"),a("code",[t._v("OP")]),t._v("开始，但它不是比特币脚本的操作符，是一个将交易原像放入解锁脚本，从而判断新的输出是否符合规定的技术。")]),t._v(" "),a("p",[t._v("假设已经有了一个交易TX1的输出out_1，其中的锁定脚本要求：解锁它的解锁脚本必须拥有一样代码逻辑，变化的只是最后包括的数字。这个TX2应该怎么做呢？TX1的锁定脚本是如何实现的呢？")]),t._v(" "),a("p",[a("img",{staticClass:"lazy",attrs:{alt:"在这里插入图片描述","data-src":"https://img-blog.csdnimg.cn/20200617102420846.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2ZyZWVkb21oZXJv,size_16,color_FFFFFF,t_70#pic_center#pic_center",loading:"lazy"}}),t._v("\n实现的技术就是"),a("code",[t._v("OP_PUSH_TX")]),t._v("， 它要求解锁参数是新交易TX2的原像")]),t._v(" "),a("p",[a("code",[t._v("OP_PUSH_TX")]),t._v("的官方文档在"),a("a",{attrs:{href:"https://scryptdoc.readthedocs.io/en/latest/contracts.html#contract-op-push-tx",target:"_blank",rel:"noopener noreferrer"}},[t._v("sCrypt语言参考"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("官方Counter代码例子")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[t._v("contract Counter "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("increment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("bytes txPreimage"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" int amount")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Tx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("checkPreimage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("txPreimage"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    bytes scriptCode "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Util"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("scriptCode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("txPreimage"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    int scriptLen "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("length")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("scriptCode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// state (i.e., counter value) is at the end")]),t._v("\n    int counter "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("unpack")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("scriptCode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("scriptLen "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" Util"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DataLen "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// increment counter")]),t._v("\n    bytes scriptCode_ "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" scriptCode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" scriptLen "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" Util"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DataLen"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("num2bin")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("counter "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Util"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DataLen"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// output: amount + scriptlen + script")]),t._v("\n    Sha256 hashOutputs "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("hash256")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("num2bin")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("amount"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Util"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("OutputValueLen"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" Util"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("writeVarint")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("scriptCode_"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ensure output is expected: amount is same with specified")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// also output script is the same with scriptCode except counter incremented")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hashOutputs "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" Util"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("hashOutputs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("txPreimage"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[a("code",[t._v("Tx.checkPreimage")]),t._v("是名叫Tx合约中的静态函数，它检查原像是否同当前交易一致。调用increment函数时，原像中包括了前一个交易锁定脚本。"),a("code",[t._v("Tx.checkPreimage")]),t._v("函数内部使用了"),a("code",[t._v("OP_CHECKSIG")]),t._v("，进行签名检查。签名检查用随机生成的公钥私钥。从而确认解锁参数提供的原像就是TX2的原像。")]),t._v(" "),a("p",[t._v("这就像DNA遗传，新诞生的小鸡必须同母鸡拥有一致的DNA，但在某些地方可以有变化。必须一致的DNA代码就写在锁定脚本中。每个新的生命，都有必须一致的那部分。")]),t._v(" "),a("p",[t._v("可以改变的部分，也必须符合规定。继续看一下上面的例子")]),t._v(" "),a("p",[a("code",[t._v("bytes scriptCode = Util.scriptCode(txPreimage)")]),t._v("这一句获取了原像TX1_OUT_1中的锁定脚本。它的最后包含数据"),a("code",[t._v("OP_RETURN 00")]),t._v("（不同的脚本也可能不包含数据）")]),t._v(" "),a("p",[t._v("有趣的是"),a("code",[t._v("scriptCode")]),t._v("如何写入原像的(虽然同本文无关)。"),a("code",[t._v("scriptCode")]),t._v("用Varint格式保存锁定脚本。Varint是一个字符串的表现形式，基本上是一个header表明数据字节长度站几个字节，是1，2，4还是8，然后获取长度len，剩下的其余部分是数据。 一个很好的资料可以看 "),a("a",{attrs:{href:"https://learnmeabitcoin.com/technical/varint",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://learnmeabitcoin.com/technical/varint"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("img",{staticClass:"lazy",attrs:{alt:"在这里插入图片描述","data-src":"https://img-blog.csdnimg.cn/20200905172914121.png#pic_center",loading:"lazy"}})]),t._v(" "),a("p",[t._v("然后从原像最后一个字节取出 counter "),a("code",[t._v("00")]),t._v(", 加一，置换原像最后一个字节为 "),a("code",[t._v("01")])]),t._v(" "),a("p",[t._v("counter就是可变部分，他要求新的输出TX2中的锁定脚本的最后一个字节必须是"),a("code",[t._v("01")]),t._v("。如果再有新的交易TX3,TX4，每一次counter的数字都加一。")]),t._v(" "),a("p",[t._v("判断的办法是检查原像中的"),a("code",[t._v("hashOutputs")]),t._v("， 在签名类型为ALL的时候，会对TX2的"),a("strong",[t._v("所有输出")]),t._v("，采用 "),a("code",[t._v("satoshis(8个字节， UInt64LE类型) + 锁定脚本(Varint格式)")]),t._v("串接成字节数组，最后sha256(sha256(b)) 。")]),t._v(" "),a("p",[t._v("在脚本中计算的"),a("code",[t._v("hashOutputs")]),t._v("同原像中的"),a("code",[t._v("hashOutputs")]),t._v("一致，可以说明新的TX2输出符合要求。")]),t._v(" "),a("p",[t._v("注意⚠️计算"),a("code",[t._v("hashOutputs")]),t._v("是TX2的"),a("strong",[t._v("所有输出")]),t._v("，这里是可能遇到的难点。在官方例子中严格假设只有一个输入和一个输出。在别的例子中要求一个输入两个输出，或者两个输入一个输出。")]),t._v(" "),a("p",[t._v("另外一个问题就是"),a("code",[t._v("OP_RETURN")]),t._v("后面的数据格式，目前采用字节拼接的方式\n"),a("code",[t._v("counter.dataLoad = num2bin(0, DataLen)")]),t._v("\n虽然可行，但也许有更加好的方案。")]),t._v(" "),a("p",[t._v("想要比特币上的Token吗？敬请期待...")]),t._v(" "),a("blockquote",[a("p",[t._v("享受比特币带来的安全自由， 关注使用"),a("a",{attrs:{href:"https://note.sv",target:"_blank",rel:"noopener noreferrer"}},[t._v("NoteSV"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=e.exports}}]);